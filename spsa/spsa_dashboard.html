<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPSA Tuning Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #00d9ff;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #16213e;
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d9ff;
        }
        .stat-label {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .stat-value.positive { color: #00ff88; }
        .stat-value.negative { color: #ff6b6b; }
        .chart-container {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 900px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
        .chart-title {
            color: #00d9ff;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .params-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .params-table th, .params-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .params-table th {
            color: #00d9ff;
            background: #0f3460;
        }
        .params-table tr:hover {
            background: #1f4068;
        }
        .change-positive { color: #00ff88; }
        .change-negative { color: #ff6b6b; }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #00d9ff;
            color: #1a1a2e;
            border: none;
            padding: 15px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.3);
        }
        .refresh-btn:hover {
            background: #00b8d9;
        }
        #lastUpdate {
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-top: 20px;
        }
        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>SPSA Tuning Dashboard</h1>
    <p class="subtitle">SleepMind Chess Engine - Fishtest Style SPSA</p>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value" id="iterations">-</div>
            <div class="stat-label">Iterations</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="currentScore">-</div>
            <div class="stat-label">Last θ+ Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avgScore">-</div>
            <div class="stat-label">Avg Score (last 10)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="eloDiff">-</div>
            <div class="stat-label">Last Elo Diff</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">θ+ vs θ- Score Over Time (0.5 = equal)</div>
        <canvas id="scoreChart"></canvas>
    </div>

    <div class="chart-row">
        <div class="chart-container">
            <div class="chart-title">Elo Difference per Iteration</div>
            <canvas id="eloChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Score Distribution</div>
            <canvas id="histogramChart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Parameter Evolution (Normalized 0-1)</div>
        <canvas id="paramsChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">Current Parameters</div>
        <table class="params-table">
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Default</th>
                    <th>Current</th>
                    <th>Change</th>
                    <th>Min</th>
                    <th>Max</th>
                </tr>
            </thead>
            <tbody id="paramsTableBody">
            </tbody>
        </table>
    </div>

    <p id="lastUpdate"></p>
    <button class="refresh-btn" onclick="loadData()">Refresh</button>

    <script>
        // Parameter defaults and ranges (must match spsa_tuning.py)
        const PARAMETERS = {
            "LMR_FullDepthMoves": { default: 3, min: 1, max: 10 },
            "LMR_ReductionLimit": { default: 2, min: 1, max: 6 },
            "NullMove_Reduction": { default: 3, min: 1, max: 5 },
            "NullMove_MinDepth": { default: 3, min: 1, max: 6 },
            "Futility_Margin": { default: 150, min: 50, max: 400 },
            "Futility_MarginD2": { default: 300, min: 100, max: 600 },
            "Futility_MarginD3": { default: 450, min: 150, max: 800 },
            "RFP_Margin": { default: 80, min: 50, max: 300 },
            "RFP_MaxDepth": { default: 8, min: 2, max: 10 },
            "Aspiration_Window": { default: 100, min: 10, max: 200 }
        };

        let scoreChart, eloChart, histogramChart, paramsChart;

        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: { color: '#eee' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#888' },
                        grid: { color: '#333' }
                    },
                    y: {
                        ticks: { color: '#888' },
                        grid: { color: '#333' }
                    }
                }
            };

            scoreChart = new Chart(document.getElementById('scoreChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: chartOptions
            });

            eloChart = new Chart(document.getElementById('eloChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: false }
                    }
                }
            });

            histogramChart = new Chart(document.getElementById('histogramChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: false }
                    },
                    scales: {
                        ...chartOptions.scales,
                        x: {
                            ...chartOptions.scales.x,
                            title: { display: true, text: 'Score Range', color: '#888' }
                        },
                        y: {
                            ...chartOptions.scales.y,
                            title: { display: true, text: 'Count', color: '#888' }
                        }
                    }
                }
            });

            paramsChart = new Chart(document.getElementById('paramsChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            title: { display: true, text: 'Normalized Value (0-1)', color: '#888' },
                            min: 0,
                            max: 1
                        }
                    }
                }
            });
        }

        function normalizeParam(name, value) {
            const p = PARAMETERS[name];
            return (value - p.min) / (p.max - p.min);
        }

        function updateCharts(data) {
            if (!data || data.length === 0) return;

            const iterations = data.map(d => d.iteration);
            const scores = data.map(d => d.score);
            const eloDiffs = data.map(d => d.elo_diff);

            // Calculate moving average (window of 10)
            const movingAvg = scores.map((_, i) => {
                const start = Math.max(0, i - 9);
                const slice = scores.slice(start, i + 1);
                return slice.reduce((a, b) => a + b, 0) / slice.length;
            });

            // Score chart with moving average
            scoreChart.data.labels = iterations;
            scoreChart.data.datasets = [
                {
                    label: 'θ+ Score',
                    data: scores,
                    borderColor: '#00d9ff',
                    backgroundColor: 'rgba(0, 217, 255, 0.1)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3
                },
                {
                    label: 'Moving Avg (10)',
                    data: movingAvg,
                    borderColor: '#00ff88',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    borderWidth: 2
                },
                {
                    label: 'Baseline (0.5)',
                    data: iterations.map(() => 0.5),
                    borderColor: '#ff6b6b',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }
            ];
            scoreChart.update();

            // Elo chart (bar chart with colors based on value)
            eloChart.data.labels = iterations;
            eloChart.data.datasets = [{
                label: 'Elo Diff',
                data: eloDiffs,
                backgroundColor: eloDiffs.map(e => e >= 0 ? 'rgba(0, 255, 136, 0.7)' : 'rgba(255, 107, 107, 0.7)'),
                borderColor: eloDiffs.map(e => e >= 0 ? '#00ff88' : '#ff6b6b'),
                borderWidth: 1
            }];
            eloChart.update();

            // Histogram of scores
            const bins = [0, 0.35, 0.45, 0.50, 0.55, 0.65, 1.0];
            const binLabels = ['<35%', '35-45%', '45-50%', '50-55%', '55-65%', '>65%'];
            const binCounts = new Array(6).fill(0);
            scores.forEach(s => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (s >= bins[i] && s < bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            });

            histogramChart.data.labels = binLabels;
            histogramChart.data.datasets = [{
                data: binCounts,
                backgroundColor: [
                    'rgba(255, 107, 107, 0.7)',
                    'rgba(255, 170, 0, 0.7)',
                    'rgba(255, 255, 0, 0.7)',
                    'rgba(255, 255, 0, 0.7)',
                    'rgba(0, 217, 255, 0.7)',
                    'rgba(0, 255, 136, 0.7)'
                ]
            }];
            histogramChart.update();

            // Parameters chart (normalized)
            const paramNames = Object.keys(PARAMETERS);
            const colors = [
                '#00d9ff', '#00ff88', '#ff6b6b', '#ffaa00', '#aa00ff',
                '#ff00aa', '#00ffaa', '#ffff00', '#00aaff', '#ff5500'
            ];

            paramsChart.data.labels = iterations;
            paramsChart.data.datasets = paramNames.map((name, i) => ({
                label: name,
                data: data.map(d => d.params[name] !== undefined ? normalizeParam(name, d.params[name]) : null),
                borderColor: colors[i % colors.length],
                fill: false,
                tension: 0.3,
                pointRadius: 1
            }));
            paramsChart.update();
        }

        function updateStats(data) {
            if (!data || data.length === 0) {
                document.getElementById('iterations').textContent = '0';
                document.getElementById('currentScore').textContent = '-';
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('eloDiff').textContent = '-';
                return;
            }

            const latest = data[data.length - 1];
            const scores = data.map(d => d.score);
            const last10 = scores.slice(-10);
            const avgLast10 = last10.reduce((a, b) => a + b, 0) / last10.length;

            document.getElementById('iterations').textContent = latest.iteration;
            document.getElementById('currentScore').textContent = latest.score.toFixed(3);
            document.getElementById('avgScore').textContent = avgLast10.toFixed(3);

            const eloEl = document.getElementById('eloDiff');
            eloEl.textContent = (latest.elo_diff >= 0 ? '+' : '') + latest.elo_diff.toFixed(1);
            eloEl.className = 'stat-value ' + (latest.elo_diff >= 0 ? 'positive' : 'negative');

            // Update params table
            const tbody = document.getElementById('paramsTableBody');
            tbody.innerHTML = '';
            for (const [name, info] of Object.entries(PARAMETERS)) {
                const current = latest.params[name];
                if (current === undefined) continue;

                const change = current - info.default;
                const changeClass = change > 0 ? 'change-positive' : (change < 0 ? 'change-negative' : '');
                const changeStr = change > 0 ? `+${change}` : change.toString();

                tbody.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${info.default}</td>
                        <td><strong>${current}</strong></td>
                        <td class="${changeClass}">${changeStr}</td>
                        <td>${info.min}</td>
                        <td>${info.max}</td>
                    </tr>
                `;
            }
        }

        async function loadData() {
            try {
                const response = await fetch('spsa_history.json?' + Date.now());
                if (!response.ok) throw new Error('File not found');
                const data = await response.json();

                updateStats(data);
                updateCharts(data);

                document.getElementById('lastUpdate').textContent =
                    'Last updated: ' + new Date().toLocaleString();
            } catch (e) {
                console.log('Could not load data:', e);
                document.getElementById('lastUpdate').textContent =
                    'No data found. Run spsa_tuning.py first.';
            }
        }

        // Initialize
        initCharts();
        loadData();

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
