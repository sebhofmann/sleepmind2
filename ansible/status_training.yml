---
# Playbook zum Pr√ºfen des Training-Status
# Verwendung: ansible-playbook -i inventory.yml status_training.yml

- name: SleepMind - Check Training Status
  hosts: training_nodes
  become: yes
    
  tasks:
    - name: Check running training processes
      shell: pgrep -x training | wc -l
      register: process_count
      changed_when: false

    - name: Count generated positions
      shell: |
        total=0
        if [ -f {{ output_dir }}/training_combined.txt ]; then
          total=$(wc -l < {{ output_dir }}/training_combined.txt)
        fi
        temp=0
        if ls {{ output_dir }}/training_temp_*.* 1> /dev/null 2>&1; then
          temp=$(cat {{ output_dir }}/training_temp_*.* 2>/dev/null | wc -l)
        fi
        echo "$((total + temp))"
      register: position_count
      changed_when: false

    - name: Get last log lines
      shell: tail -5 {{ output_dir }}/training.log 2>/dev/null || echo "No log file"
      register: log_tail
      changed_when: false

    - name: Show status
      debug:
        msg: |
          === {{ inventory_hostname }} ===
          Prozesse:   {{ process_count.stdout }}
          Positionen: {{ position_count.stdout }}
          Log: {{ log_tail.stdout }}
